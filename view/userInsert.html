<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>Veltrix - Responsive Bootstrap 4 Admin Dashboard</title>
    <meta content="Admin Dashboard" name="description"/>
    <meta content="Themesbrand" name="author"/>
    <link rel="shortcut icon" href="../assets/images/favicon.ico">
    <!--<link href="http://cdn.bootstrapmb.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">-->
    <!--bootstrap4版本不支持bootstrapValidator的样式，所以后面的图标不显示，但是可以验证-->
    <!--<link rel="stylesheet" href="https://cdn.bootcss.com/twitter-bootstrap/3.3.7/css/bootstrap.min.css">-->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../assets/css/bootstrapValidator.min.css" rel="stylesheet" type="text/css">
    <link href="../assets/css/metisMenu.min.css" rel="stylesheet" type="text/css">
    <link href="../assets/css/icons.css" rel="stylesheet" type="text/css">
    <link href="../assets/css/style.css" rel="stylesheet" type="text/css">
</head>

<body>

<!-- Begin page -->
<div id="wrapper">

    <!-- Top Bar Start -->
    <div class="topbar">
        <!-- LOGO -->
        <div class="topbar-left">
            <a href="index.html" class="logo">
                <span><img src="../assets/images/logo-light.png" alt="" height="18"></span>
                <i><img src="../assets/images/logo-sm.png" alt="" height="22"></i>
            </a>
        </div>
        <nav class="navbar-custom">
            <ul class="list-inline menu-left mb-0">
                <li class="float-left">
                    <button class="button-menu-mobile open-left waves-effect">
                        <i class="mdi mdi-menu"></i>
                    </button>
                    <span style="font-size: 18px;margin-left: 5px;">用户录入</span>
                </li>
            </ul>
        </nav>
    </div>
    <!-- Top Bar End -->

    <!--  Left Sidebar Start -->
    <div id="leftMenu">

    </div>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="content-page" id="content">
        <!-- 页面主体内容开始 -->
        <div class="content">
            <div class="container-fluid">
                <div class="content">
                    <div class="container-fluid">
                        <div class="page-title-box">
                            <h4 class="page-title">输入用户信息</h4>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <form id="userForm">
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label >姓名</label>
                                                        <input v-model="params.userName" name="userName" type="text" class="form-control">
                                                    </div>
                                                    <div class="form-group">
                                                        <label >密码</label>
                                                        <input v-model="params.userPassword" name="userPassword" type="password" class="form-control">
                                                    </div>
                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label>手机号</label>
                                                        <input v-model="params.userPhone" name="userPhone" type="text" class="form-control">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>邮箱</label>
                                                        <input v-model="params.userEmail" name="userEmail" type="text" class="form-control">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-sm-6">

                                                    <div class="form-group">
                                                        <label>确认密码</label>
                                                        <input name="reuserPassword" type="password" class="form-control">
                                                    </div>

                                                    <div class="form-group">
                                                        <label>出生日期</label>
                                                        <input v-model="params.userBirthday" name="userBirthday" class="form-control" type="date">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>性别</label>
                                                        <div class="row">
                                                            <div class="custom-control custom-radio col-sm-2" style="margin-left: 18px">
                                                                <input v-model="params.userSex" type="radio" value="0" id="customRadio1" name="userSex" class="custom-control-input">
                                                                <label class="custom-control-label" for="customRadio1">男</label>
                                                            </div>
                                                            <div class="custom-control custom-radio col-sm-2">
                                                                <input v-model="params.userSex" type="radio" value="1" id="customRadio2" name="userSex" class="custom-control-input">
                                                                <label class="custom-control-label" for="customRadio2">女</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-sm-6">
                                                            <div class="form-group">
                                                                <label class="control-label">权限</label>
                                                                <select v-model="params.jdictionId" class="form-control" name="jdictionId">
                                                                    <option value="null">请选择权限</option>
                                                                    <option value="0">销售员</option>
                                                                    <option value="1">普通用户</option>
                                                                </select>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <div class="form-group">
                                                                <label class="control-label">状态</label>
                                                                <select v-model="params.userStatus" class="form-control" name="userStatus">
                                                                    <option value="null">请选择状态</option>
                                                                    <option value="0">启用</option>
                                                                    <option value="1">禁用</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="col-sm-6" id="vipDiv">
                                                            <div class="form-group">
                                                                <label class="control-label">是否会员</label>
                                                                <select  v-model="params.vip" class="form-control">
                                                                    <option value="0">否</option>
                                                                    <option value="1">是</option>
                                                                </select>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-6" id="ciiDiv">
                                                            <div class="form-group">
                                                                <label class="control-label">收货地址</label>
                                                                <select v-model="params.consigneeInformationId" class="form-control">
                                                                    <option value="null">收货地址</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>

                                                <div class="col-sm-6">
                                                    <div class="form-group">
                                                        <label>头像</label> <br>
                                                        <img src="" class="img-fluid rounded img" style="max-width: 200px;">
                                                        <br>
                                                        <input type="file" name="photo" id="userHphoto" class="form-control"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <button type="button" id="insertUser" @click="userInsert()" class="btn btn-success mr-1 waves-effect waves-light">保存</button>
                                                <button type="button" id="updateUser" @click="updateUser()" class="btn btn-success mr-1 waves-effect waves-light">修改</button>
                                                <button type="reset" class="btn btn-secondary waves-effect">重置</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <div class="card">
                                </div>
                            </div>
                        </div>
                        <!-- end row -->

                    </div>
                    <!-- container-fluid -->

                </div>
            </div>
        </div>
        <!-- 页面主体内容结束 -->
        <footer class="footer">
            © 2020 毕业设计 <span class="d-none d-sm-inline-block"> - <i class="mdi mdi-heart text-danger"></i> by 张正华.</span>
        </footer>

    </div>

    <!-- ============================================================== -->
    <!-- End Right content here -->
    <!-- ============================================================== -->

</div>
<!-- END wrapper -->

<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/vue.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/bootstrapValidator.min.js"></script>
<script src="../assets/js/metisMenu.min.js"></script>
<script src="../assets/js/jquery.slimscroll.js"></script>
<script src="../assets/js/waves.min.js"></script>
<!-- App js -->
<!--<script src="../assets/js/app.js"></script>-->
<script>
    $(function () {
        //加载左边菜单
        $("#leftMenu").load("leftMenu.html");
        //显示图片
        $("#userHphoto").change(function() {
            /*在改变照片时，清空以前图片*/
            $(".img").empty();
            var oFReader = new FileReader();
            var file = document.getElementById('userHphoto').files[0];
            oFReader.readAsDataURL(file);
            oFReader.onloadend = function(oFRevent){
                var src = oFRevent.target.result;
                $(".img").attr("src",src);
            }
        });
    })
</script>
<script>
    var vm = new Vue({
        el:"#content",
        data:{
            params:{
                userId:null,
                userSex: 0,
                userHphoto:null,
                vip:0,
            }
        },
        mounted:function () {

            //隐藏 vip 和 收货地址框 修改按钮
            $("#vipDiv").hide();
            $("#ciiDiv").hide();
            $("#updateUser").hide();

            //初始化表单验证
            $("#userForm").bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                //验证规则 对应表单中的 name 属性
                fields:{
                    userName:{
                        validators:{
                            notEmpty:{//非空验证
                                message: '姓名不能为空'
                            },
                            stringLength:{ //验证长度
                                min:2,
                                max:6,
                                message:'长度在2-6之间'
                            }
                        }
                    },
                    userPassword:{
                        validators:{
                            notEmpty: {
                                message:'密码不能为空'
                            },
                            stringLength:{ //验证长度
                                min:6,
                                max:12,
                                message:'长度在6-12之间'
                            }
                        }

                    },
                    reuserPassword:{
                        validators:{
                            identical: {//与指定控件内容比较是否相同，比如两次密码不一致
                                field: 'userPassword',//指定控件name
                                message: '两次密码不一致'
                            }
                        }
                    },
                    userPhone:{
                        validators:{
                            notEmpty:{
                                message:'手机号不能为空'
                            },
                            regexp: {
                                regexp: /^1\d{10}$/,
                                message: '手机号格式错误'
                            },
                            /*remote:{ //将内容发送至指定页面验证，返回验证结果，比如查询手机号是否存在

                            }*/
                        }
                    },
                    userEmail:{
                        validators:{
                            notEmpty:{
                                message:'邮箱不能为空'
                            },
                            regexp:{
                                regexp:/^\w+@[a-zA-Z0-9]{2,10}(?:\.[a-z]{2,4}){1,3}$/,
                                message:'邮箱格式错误'
                            }
                        }
                    },
                    userBirthday:{
                        validators:{
                            notEmpty:{
                                message:'请选择出生日期'
                            }
                        }
                    },
                    userSex:{
                        validators:{
                            notEmpty:{
                                message:'请选择性别'
                            }
                        }
                    },
                    jdictionId:{
                        validators:{
                            notEmpty:{
                                message:'请选择权限'
                            }
                        }
                    },
                    userStatus:{
                        validators:{
                            notEmpty:{
                                message:'请选择状态'
                            }
                        }
                    },
                    photo:{
                        validators:{
                            notEmpty:{
                                message:'请选择图片'
                            }
                        }
                    }
                }
            });

            this.showUserData();
        },
        methods:{
            //添加用户信息
            userInsert:function () {
                //手动验证表单
                $("#userForm").data('bootstrapValidator').validate();
                //获得验证状态
                var flag = $("#userForm").data('bootstrapValidator').isValid();
                //判断是否验证成功，成功添加用户信息
                if(flag){
                    //上传头像
                    $.ajax({
                        type:"POST",
                        url:"http://localhost:9000/upload/uploadPhoto?type=user",
                        dataType:"json",
                        cache:false,
                        processData: false,
                        contentType:false,
                        data: new FormData($("#userForm")[0]),
                        success:function (data) {
                           if (data.code === 0){
                               //绑定用户头像名称，然后添加用户信息
                               vm.params.userHphoto = "http://localhost:9000/img/users/"+data.fileName + data.extendedName;
                               $.ajax({
                                   type: "POST",
                                   url:"http://localhost:9000/users/addUser",
                                   dataType:"json",
                                   contentType: "application/json; charset=UTF-8",
                                   data:JSON.stringify(vm.params),
                                   success:function (data) {
                                      if (data.code === 0){
                                          alert(data.msg);
                                      }else {
                                          alert(data.msg);
                                      }
                                   }
                               });
                           }else {
                               alert(data.msg);
                           }
                        }
                    });
                }else {
                    //alert("验证失败！")
                }
            },
            //显示用户信息
            showUserData(){
                //从缓存里面拿到用户信息
                var userDate = JSON.parse(window.sessionStorage.getItem("userData"));
                if (userDate != null){
                    this.params = userDate;
                    //显示头像,vip,收货地址
                    $(".img").attr("src",this.params.userHphoto);
                    $("#vipDiv").show();
                    $("#ciiDiv").show();
                    $("#updateUser").show();
                    $("#insertUser").hide();
                }
            },
            //修改用户信息
            updateUser:function () {
                //判断用户有没有修改图片
                var userHphoto = $("#userHphoto").val();
                //没有修改图片就只修改用户信息
                if (userHphoto == ""){
                    $.ajax({
                        type: "POST",
                        url:"http://localhost:9000/users/updateUser",
                        dataType:"json",
                        //async:false, //同步
                        contentType: "application/json; charset=UTF-8",
                        data:JSON.stringify(vm.params),
                        success:function (data) {
                            if (data.code == 0){
                                alert(data.msg);
                            }else {
                                alert(data.msg);
                            }
                        }
                    });
                }else {
                    /**
                     * 1、删除原图片
                     * 2、上传新图片
                     * 3、修改用户信息
                     */
                    var url = "http://localhost:9000/upload/deletePhoto?type=user";
                    var args = {
                        photo: vm.params.userHphoto
                    }
                    //删除图片
                    $.post(url,args,function (data) {
                       if (data.code === 0){
                           //上传图片
                           $.ajax({
                               type:"POST",
                               url:"http://localhost:9000/upload/uploadPhoto?type=user",
                               dataType:"json",
                               cache:false,
                               processData: false,
                               contentType:false,
                               data: new FormData($("#userForm")[0]),
                               success:function (data) {
                                   if (data.code === 0){
                                       //绑定用户头像名称，然后修改用户信息
                                       vm.params.userHphoto = "http://localhost:9000/img/users/"+data.fileName + data.extendedName;
                                       $.ajax({
                                           type: "POST",
                                           url:"http://localhost:9000/users/updateUser",
                                           dataType:"json",
                                           contentType: "application/json; charset=UTF-8",
                                           data:JSON.stringify(vm.params),
                                           success:function (data) {
                                               if (data.code === 0){
                                                   alert(data.msg);
                                               }else {
                                                   alert(data.msg);
                                               }
                                           }
                                       });
                                   }else {
                                       alert(data.msg);
                                   }
                               }
                           });
                       } else {
                           alert(data.msg);
                       }
                    });

                }
            }
        }
    });
</script>
</body>
</html>
