<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Index</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <meta name="keywords" content="blog, business, clean, clear, cooporate, creative, design web, flat, marketing, minimal, portfolio, shop, shopping, unique">
    <meta name="author" content="MARTECH | Deer Creative Theme">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/custom_bootstrap.css">
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/elegant.css">
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="assets/css/slick.css">
    <link rel="stylesheet" href="assets/css/scroll.css">
    <link rel="stylesheet" href="assets/css/icomoon.css">
    <link rel="stylesheet" href="assets/css/jquery.fancybox.min.css">
    <link rel="shortcut icon" href="assets/images/shortcut_logo.png">
  </head>
  <link rel="stylesheet" href="assets/css/jquery-ui.min.css">
  <body>
    <div id="main">
      <!-- End header-->
      <div class="ogami-breadcrumb">
        <div class="container">
          <ul>
            <li> <a class="breadcrumb-link" href="index.html"> <i class="fas fa-home"></i>首页</a></li>
            <li> <a class="breadcrumb-link" href="index.html">咖啡</a></li>
            <li> <a class="breadcrumb-link active" href="index.html">咖啡购物车</a></li>
          </ul>
        </div>
      </div>
      <!-- End order step-->
      <div class="shopping-cart">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <div class="product-table">
                <table class="table table-responsive"> 
                  <colgroup>
                    <col span="1" style="width: 15%">
                    <col span="1" style="width: 30%">
                    <col span="1" style="width: 15%">
                    <col span="1" style="width: 15%">
                    <col span="1" style="width: 15%">
                    <col span="1" style="width: 10%">
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="product-iamge" scope="col">图片</th>
                      <th class="product-name" scope="col">名称</th>
                      <th class="product-price" scope="col">价格</th>
                      <th class="product-quantity" scope="col">数量</th>
                      <th class="product-total" scope="col">合计</th>
                      <th class="product-clear" scope="col"> 
                        <button class="no-round-btn"><i class="icon_close"></i></button>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(data,index) in shoppingList">
                      <td class="product-iamge"> 
                        <div class="img-wrapper"><img :src="data.coffeePhoto"></div>
                      </td>
                      <td class="product-name">{{data.coffeeName}}</td>
                      <td class="product-price">{{data.transactionPrice}}</td>
                      <td class="product-quantity"> 
                        <input class="quantity no-round-input" type="number" min="1" :value="num[index]" @change="changeCount($event,index,data.transactionPrice)">
                      </td>
                      <td class="product-total">￥{{data.transactionPrice * num[index]}}</td>
                      <td class="product-clear"> 
                        <button class="no-round-btn" @click="removeShopping(data)"><i class="icon_close"></i></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="row justify-content-end">
            <div class="col-12 col-md-6 col-lg-4">
              <div class="cart-total_block">
                <h2>选择收货地址</h2>
                <table class="table">
                  <colgroup>
                    <col span="1" style="width: 50%">
                    <col span="1" style="width: 50%">
                  </colgroup>
                  <tbody>
                  <tr>
                    <select class="form-control" style="margin-top: 32px" v-model="consigneeInformationId">
                      <option v-for="(data,index) in consigneeList" :value="data.consigneeInformationId">{{data.consigneeInformationName}}——{{data.consigneeInformationPhone}}</option>
                    </select>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-12 col-md-6 col-lg-4">
              <div class="cart-total_block">
                <h2>总价</h2>
                <table class="table">
                  <colgroup>
                    <col span="1" style="width: 50%">
                    <col span="1" style="width: 50%">
                  </colgroup>
                  <tbody>
                    <tr>
                      <th>合计</th>
                      <td>￥{{priceTotal}}</td>
                    </tr>
                  </tbody>
                </table>
                <div class="checkout-method">
                  <button class="normal-btn" @click="buyCoffee()">购买</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- End shopping cart-->
      <div class="partner">
        <div class="container">
          <div class="partner_block d-flex justify-content-between" data-slick="{&quot;slidesToShow&quot;: 6}">
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_02.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_02.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_02.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href=""><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
          </div>
        </div>
      </div>
      <!-- End partner-->
      <footer class="coffee">
        <div class="container">
          <div class="row">
            <div class="col-12 col-sm-12 col-md-4 text-sm-center text-md-left">
              <div class="footer-logo"><img src="assets/images/logo.png" alt=""></div>
              <div class="footer-contact">
                <p>地址: 贵州山咔咔里</p>
                <p>电话: 18396910028</p>
                <p>Email: 266255255@gmail.com</p>
              </div>
              <div class="footer-social"><a class="round-icon-btn coffee" href=""><i class="fab fa-facebook-f"> </i></a><a class="round-icon-btn coffee" href=""><i class="fab fa-twitter"></i></a><a class="round-icon-btn coffee" href=""><i class="fab fa-invision"> </i></a><a class="round-icon-btn coffee" href=""><i class="fab fa-pinterest-p"></i></a></div>
            </div>
            <div class="col-md-8">
              <div class="row">
                <div class="col-12 col-sm-4 text-sm-center text-md-left">
                  <div class="footer-quicklink">
                    <h5>信息化</h5><a href="about_us.html">关于我们</a><a href="checkout.html">退房</a><a href="contact.html">联系</a><a href="about_us.html">服务</a>
                  </div>
                </div>
                <div class="col-12 col-sm-4 text-sm-center text-md-left">
                  <div class="footer-quicklink">
                    <h5>My 我的账户</h5><a href="login.html">我的账户</a><a href="contact.html">联系</a><a href="shop_cart.html">购物车</a><a href="shop_grid+list_3col.html">店铺</a>
                  </div>
                </div>
                <div class="col-12 col-sm-4 text-sm-center text-md-left">
                  <div class="footer-quicklink">
                    <h5>快速店铺</h5><a href="about_us.html">关于我们</a><a href="checkout.html">退房</a><a href="contact.html">联系</a><a href="about_us.html">服务</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="newletter">
          <div class="container">
            <div class="row justify-content-between align-items-center">
              <div class="col-12 col-md-7">
                <div class="newletter_text text-center text-md-left">
                  <h5>立即加入哦们的新闻通讯</h5>
                  <p>获取我们最新商品和特惠信息的电子邮件.</p>
                </div>
              </div>
              <div class="col-12 col-md-5">
                <div class="newletter_input">
                  <input class="round-input" type="text" placeholder="Enter your email">
                  <button>Subcribe</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="footer-credit">
          <div class="container">
            <div class="footer-creadit_block d-flex flex-column flex-md-row justify-content-start justify-content-md-between align-items-baseline align-items-md-center">
              <p class="author">贵州民族大学2016级软件工程3班 <a href="http://www.17sucai.com/" title="17sucai">王显成，曹江柳，张正华</a>.</p><img class="payment-method" src="assets/images/payment.png" alt="">
            </div>
          </div>
        </div>
      </footer>
      <!-- End footer-->
    </div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery-ui.min.js"></script>
    <script src="../assets/js/vue.min.js"></script>
    <script src="assets/js/jquery.countdown.min.js"></script>
    <script src="assets/js/slick.min.js"></script>
    <script src="assets/js/jquery.easing.js"></script>
    <script src="assets/js/jquery.scrollUp.min.js"></script>
    <script src="assets/js/jquery.zoom.min.js"></script>
    <script src="assets/js/parallax.js"></script>
    <script src="assets/js/jquery.fancybox.js"></script>
    <script src="assets/js/numscroller-1.0.js"></script>
    <script src="assets/js/vanilla-tilt.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="../assets/js/axios.min.js"></script>
    <script>
      var vm = new Vue({
        el:"#main",
        data:{
          userInfo:{},
          shoppingList:[],
          num:[],
          total:[],
          priceTotal:0,
          consigneeList:[],
          consigneeInformationId:1,
          shoppingListParams:[],
        },
        mounted:function () {
          //获取缓存中的用户 id
          this.userInfo = JSON.parse(window.sessionStorage.getItem("userInfo"));
          this.selectShopCart();
          this.selectConsignee();
        },
        methods:{
          //获得该用户的购物车
          selectShopCart:function () {
            var url = "http://localhost:9000/coffeeOperation/selectAllShopping";
            var args = {
              "userId":this.userInfo.userId,
            };
            $.post(url,args,function (data) {
              if (data.code === 0){
                vm.shoppingList = data.shoppingList;
                var num = [];
                var total = [];
                var priceTotal = 0;
                for (var i = 0 ; i < data.shoppingList.length; i++){
                  num.push(data.shoppingList[i].transactionCount);
                  total.push(num[i] * data.shoppingList[i].transactionPrice);
                  priceTotal = priceTotal + total[i];
                }
                vm.num = num;
                vm.total = total;
                vm.priceTotal = priceTotal;
              }else {
                alert(data.msg);
              }
            });
          },

          //改变数量
          changeCount:function (event,index,transactionPrice) {
            vm.$set(this.num,index, parseInt(event.target.value));
            this.total[index] = parseInt(event.target.value) * transactionPrice;
            this.priceTotal = 0 ;
            for(var i = 0 ; i < this.total.length ; i ++){
              this.priceTotal = this.priceTotal + this.total[i];
            }
          },
          
          //移除咖啡
          removeShopping:function (data) {
            if(confirm("确定要将此商品从购物车移除吗！！！")){
              var url = "http://localhost:9000/coffeeOperation/removeShopping";
              var args = {
                "userId":vm.userInfo.userId,
                "coffeeId":data.coffeeId,
                "coffeeName":data.coffeeName,
                "coffeePhoto":data.coffeePhoto,
                "transactionPrice":data.transactionPrice,
                "transactionCount":data.transactionCount
              };
              $.post(url,args,function(data){
                if(data.code == 0){
                  vm.selectShopCart();
                }else{
                  alert(data.msg);
                }
              });
            }

            return false;
          },

          //选择收货地址
          selectConsignee:function () {
            axios({
              method:'GET',
              url:'http://localhost:9000/userOperation/selectConsignee',
              params: {"userId":this.userInfo.userId}
            }).then(res =>{
              if (res.data.code === 0){
                this.consigneeList = res.data.dataList;
              }else {
                alert(res.data.msg);
              }
            }).catch(res =>{
              console.log(res);
            })
          },

          //购买
          buyCoffee:function () {
            //this.shoppingListParams = this.shoppingList;
            for(var i = 0 ; i < this.shoppingList.length ; i ++){
              this.shoppingList[i].transactionCount = this.num[i];
            }
            var args = {
              "userId":this.userInfo.userId,
              "employeesId":0,
              "consigneeInformationId":this.consigneeInformationId,
              "orderAmount":vm.priceTotal,
              "orderStatus":2,
              "orderType":1,
              "orderDetailEntityList":vm.shoppingList,
            }
            $.ajax({
              type:"post",
              url:"http://localhost:9000/coffeeOperation/addOrder",
              async:true,
              data:JSON.stringify(args),
              dataType:"json",
              contentType:"application/json",
              success:function(data){
                if(data.code == 0){
                  //获得新添加订单的编号
                  var orderId = data.orderId;
                  //将新订单编号以指定的名字存入缓存中
                  window.sessionStorage.setItem("successOrderId",orderId);
                  var url = "http://localhost:9000/pay/aliPay";
                  var args = {
                    "amount":vm.priceTotal,
                    "orderNo":"201607090346" + orderId,
                    "orderMsg":"订单编号:201607090346" + orderId
                  };
                  $.post(url,args,function(data){
                    $("body").html(data);
                  });
                  //alert("创建订单信息成功！！！");
                  //window.location.href="dingdanzhongxin.html";
                }else{
                  alert(data.message);
                }
              }
            });

          }

        }
      })
    </script>
  </body>
</html>