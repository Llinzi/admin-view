<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Index</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <meta name="keywords" content="blog, business, clean, clear, cooporate, creative, design web, flat, marketing, minimal, portfolio, shop, shopping, unique">
    <meta name="author" content="MARTECH | Deer Creative Theme">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/custom_bootstrap.css">
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/elegant.css">
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="assets/css/slick.css">
    <link rel="stylesheet" href="assets/css/scroll.css">
    <link rel="stylesheet" href="assets/css/icomoon.css">
    <link rel="stylesheet" href="assets/css/jquery.fancybox.min.css">
    <link rel="shortcut icon" href="assets/images/shortcut_logo.png">
    <link href="../assets/css/bootstrapValidator.min.css" rel="stylesheet" type="text/css">
  </head>
  <link rel="stylesheet" href="assets/css/jquery-ui.min.css">
  <body>
    <div id="main">
      <header>
        <nav class="navigation">
          <div class="container">
            <div class="row no-gutters align-items-center">
              <div class="col-lg-2"><a class="logo" href="index.html"><img src="assets/images/logo_white.png" alt=""></a></div>
              <div class="col-lg-7">
                <h1 class="title">山咔咔里咖啡</h1>
              </div>
            </div>
          </div>
        </nav>
      </header>
      <!-- End header-->
      <div class="ogami-breadcrumb">
        <div class="container">
          <ul>
            <li> <a class="breadcrumb-link" href="index.html"> <i class="fas fa-home"></i>主页</a></li>
            <li> <a class="breadcrumb-link active" href="#">注册</a></li>
          </ul>
        </div>
      </div>
      <!-- End breadcrumb-->
      <div class="account">
        <div class="container">
          <div class="row">
            <div class="col-12 col-md-6 mx-auto">
              <h1 class="title">注册</h1>
              <form id="regForm">
                <div class="form-group">
                <label>手机号*</label>
                  <div class="row">
                    <div class="col-md-8"><input v-model="paramsReg.userPhone" class="no-round-input" id="regPhone" name="userPhone" @change="changePhone()" type="text"></div>
                    <div class="col-md-4">
                      <button v-show="showCode" :class="myDisabled ? 'no-round-btn2':'no-round-btn'" :disabled="myDisabled" @click="getCode()">获取验证码</button>
                      <span v-show="!showCode" class="no-round-btn2">{{count}}s后重发</span>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label>验证码 *</label>
                  <input class="no-round-input" id="regCode" name="code" type="text">
                </div>
                <div class="form-group">
                  <label>密码 *</label>
                  <input v-model="paramsReg.userPassword" class="no-round-input" name="userPassword" type="password">
                </div>
                <div class="form-group">
                  <label>确认密码*</label>
                  <input class="no-round-input" name="confirmPwd" type="password">
                </div>
                <div class="account-function">
                  <button class="no-round-btn" @click="userRegister()">注册</button><a class="create-account" href="login.html">返回登录</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- End account-->
      <div class="partner">
        <div class="container">
          <div class="partner_block d-flex justify-content-between" data-slick="{&quot;slidesToShow&quot;: 6}">
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_02.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_02.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href="#"><img src="assets/images/partner/partner_02.png" alt="partner logo"></a></div>
            <div class="partner--logo" href=""> <a href=""><img src="assets/images/partner/partner_01.png" alt="partner logo"></a></div>
          </div>
        </div>
      </div>
      <!-- End partner-->
      <footer class="coffee">
        <div class="container">
          <div class="row">
            <div class="col-12 col-sm-12 col-md-4 text-sm-center text-md-left">
              <div class="footer-logo"><img src="assets/images/logo.png" alt=""></div>
              <div class="footer-contact">
                <p>地址: 贵州山咔咔里</p>
                <p>电话: 18396910028</p>
                <p>Email: 266255255@gmail.com</p>
              </div>
              <div class="footer-social"><a class="round-icon-btn coffee" href=""><i class="fab fa-facebook-f"> </i></a><a class="round-icon-btn coffee" href=""><i class="fab fa-twitter"></i></a><a class="round-icon-btn coffee" href=""><i class="fab fa-invision"> </i></a><a class="round-icon-btn coffee" href=""><i class="fab fa-pinterest-p"></i></a></div>
            </div>
            <div class="col-md-8">
              <div class="row">
                <div class="col-12 col-sm-4 text-sm-center text-md-left">
                  <div class="footer-quicklink">
                    <h5>信息化</h5><a href="about_us.html">关于我们</a><a href="checkout.html">退房</a><a href="contact.html">联系</a><a href="about_us.html">服务</a>
                  </div>
                </div>
                <div class="col-12 col-sm-4 text-sm-center text-md-left">
                  <div class="footer-quicklink">
                    <h5>My 我的账户</h5><a href="login.html">我的账户</a><a href="contact.html">联系</a><a href="shop_cart.html">购物车</a><a href="shop_grid+list_3col.html">店铺</a>
                  </div>
                </div>
                <div class="col-12 col-sm-4 text-sm-center text-md-left">
                  <div class="footer-quicklink">
                    <h5>快速店铺</h5><a href="about_us.html">关于我们</a><a href="checkout.html">退房</a><a href="contact.html">联系</a><a href="about_us.html">服务</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="newletter">
          <div class="container">
            <div class="row justify-content-between align-items-center">
              <div class="col-12 col-md-7">
                <div class="newletter_text text-center text-md-left">
                  <h5>立即加入哦们的新闻通讯</h5>
                  <p>获取我们最新商品和特惠信息的电子邮件.</p>
                </div>
              </div>
              <div class="col-12 col-md-5">
                <div class="newletter_input">
                  <input class="round-input" type="text" placeholder="Enter your email">
                  <button>Subcribe</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="footer-credit">
          <div class="container">
            <div class="footer-creadit_block d-flex flex-column flex-md-row justify-content-start justify-content-md-between align-items-baseline align-items-md-center">
              <p class="author">贵州民族大学2016级软件工程3班 <a href="http://www.17sucai.com/" title="17sucai">王显成，曹江柳，张正华</a>.</p><img class="payment-method" src="assets/images/payment.png" alt="">
            </div>
          </div>
        </div>
      </footer>
      <!-- End footer-->
    </div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery-ui.min.js"></script>
    <script src="assets/js/jquery.countdown.min.js"></script>
    <script src="../assets/js/vue.min.js"></script>
    <script src="assets/js/slick.min.js"></script>
    <script src="assets/js/jquery.easing.js"></script>
    <script src="assets/js/jquery.scrollUp.min.js"></script>
    <script src="assets/js/jquery.zoom.min.js"></script>
    <script src="assets/js/parallax.js"></script>
    <script src="assets/js/jquery.fancybox.js"></script>
    <script src="assets/js/numscroller-1.0.js"></script>
    <script src="assets/js/vanilla-tilt.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="../assets/js/bootstrapValidator.min.js"></script>
  </body>
<script>
  var vm = new Vue({
    el:"#main",
    data:{
      paramsReg:{
        userStatus:0,
      },
      myDisabled:true,
      showCode:true,
      count: '',
      timer: null,
    },

    mounted:function () {
      //注册表单验证
      $("#regForm").bootstrapValidator({
        message: 'This value is not valid',
        feedbackIcons: {
          valid: 'glyphicon glyphicon-ok',
          invalid: 'glyphicon glyphicon-remove',
          validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
          userPhone:{
            message:"手机号验证失败",
            validators:{
              notEmpty:{
                message:"请输入手机号"
              },
              regexp:{
                regexp: /^1\d{10}$/,
                message:"请输入正确的手机号"
              },

              callback:{
                message:"此号码已被注册",
                callback: function () {
                  var flag = true;
                  $.ajax({
                    url:'http://localhost:9000/login/selectPhone', // 请求路径
                    type:'GET',
                    async:false,	// 同步请求，必须是false
                    data:{
                      userPhone:$('#regPhone').val() // 请求参数
                    },
                    success:function(res){
                      //console.log(res);
                      flag = res.valid;
                    }
                  });
                  return flag;
                }
              },

              /**
               * 验证手机号码是否被注册( 被注册后台返回({"valid",false}) 没有被注册返回 {"valid",true})
               * @param 参数为当前<input>的 name 的值
               */
              /*remote:{
                url: "http://localhost:9000/login/selectPhone",
                message:"此号码已被注册",
                type: "GET"
              }*/
            }
          },
          code:{
            message:"验证码验证失败",
            validators:{
              notEmpty:{
                message:"请输入验证码"
              },
              remote:{
                url: "http://localhost:9000/login/validationCode",
                message:"验证码错误",
                type: "GET",
                delay:2000,//每输入一个字符，就发ajax请求，服务器压力还是太大，设置2秒发送一次ajax（默认输入一个字符，提交一次，服务器压力太大）
                data:function (validator) {
                  return{
                    "phone":$("#regPhone").val(),
                    "code":$("#regCode").val()
                  };
                }
              },
            }
          },
          userPassword:{
            message:"密码验证失败",
            validators:{
              notEmpty:{
                message:"请输入验证码"
              },
              regexp:{
                regexp: /^.*(?=.{6,})(?=.*\d)(?=.*[A-Z])(?=.*[a-z]).*$/,
                message:"密码为数字+小写字母+大写字母组合且不小于6位",
              },
            }
          },
          confirmPwd:{
            message:"确认密码验证失败",
            validators:{
              notEmpty:{
                message:"确认密码不能为空"
              },
              identical:{
                field:"userPassword",
                message:"两次密码不一致"
              }
            }
          }
        }
      });
    },

    methods:{

      changePhone:function(){
        //获取手机号验证状态
        var flag = $("#regForm").data("bootstrapValidator").isValidField('userPhone');
        console.log(flag);
        if (flag){
          this.myDisabled = false;
        }else {
          this.myDisabled = true;
        }
      },

      getCode:function () {
        const TIME_COUNT = 60;
        if (!this.timer) {
          this.count = TIME_COUNT;
          this.showCode = false;
          this.timer = setInterval(() => {
            if (this.count > 0 && this.count <= TIME_COUNT) {
              this.count--;
            } else {
              this.showCode = true;
              clearInterval(this.timer);
              this.timer = null;
            }
          }, 1000)
        }

        $.ajax({
          url:"http://localhost:9000/login/sendMsg",
          type:"GET",
          dataType: "json",
          data:{
            "phone":$('#regPhone').val(),
            "type":'reg'
          },
          success:function (data) {
            if ( data.code === 0 ){
              alert("发送验证码中");
            }else {
              alert(data.msg);
            }
          }
        });

      },

      userRegister:function () {
        //手动验证表单
        $("#regForm").data("bootstrapValidator").validate();
        //获取表单验证状态
        var flag = $("#regForm").data("bootstrapValidator").isValid();
        if (flag){
          $.ajax({
            url:"http://localhost:9000/users/addUser",
            type:"POST",
            dataType:"json",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(vm.paramsReg),
            success:function (data) {
              //console.log(data);
              if (data.code === 0){
                alert("注册成功!");
                window.location.href="login.html";
              }else {
                alert(data.msg);
              }
            }
          });
        }else {
          alert("验证失败！")
        }
      }

    }

  })
</script>
</html>